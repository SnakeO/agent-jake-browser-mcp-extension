# v2.2.0 Connection State Simulation

## Overview
Testing connection state updates for the SERVER indicator in the Chrome extension popup.

## Setup

### Servers Required
| Server | Port | Purpose |
|--------|------|---------|
| Laravel | 8000 | API authentication |
| Reverb | 8085 | WebSocket for real-time commands |
| browser-mcp | 8765 | Local MCP tool commands |

### Extension Configuration
```typescript
// src/types/config.ts
API_URL: 'http://localhost:8000',
REVERB_HOST: 'localhost',
REVERB_PORT: 8085,
REVERB_APP_KEY: 'sortie-extension-key',
WS_PORT: 8765,
```

---

## Bug #1: Disconnect Not Reflected in UI

### Problem
When Reverb server was stopped, the SERVER indicator continued showing "ONLINE" instead of "OFFLINE/RETRY".

### Root Cause
In `src/background/reverb-client.ts`, the `disconnected` event handler only scheduled a reconnect but didn't update the connection state.

### Fix
```typescript
// Before
pusher.connection.bind('disconnected', () => {
  console.log('[ReverbClient] Pusher disconnected');
  this.notifyListeners();
  this.scheduleReconnect('Pusher disconnected');
});

// After
pusher.connection.bind('disconnected', () => {
  console.log('[ReverbClient] Pusher disconnected');
  this.connectionState.handleError(
    ErrorCodes.WEBSOCKET_ERROR,
    'Pusher disconnected'
  );
  this.notifyListeners();
  this.scheduleReconnect('Pusher disconnected');
});
```

### Simulation
1. Start all servers → SERVER shows ONLINE ✓
2. Stop Reverb (`Ctrl+C` on `php artisan reverb:start`)
3. Expected: SERVER changes to RETRY/OFFLINE within 5 seconds
4. Result: ✓ PASS

---

## Bug #2: Reconnect Not Reflected in UI

### Problem
After Reverb was stopped and restarted, the SERVER indicator stayed "OFFLINE" instead of returning to "ONLINE".

### Root Cause
The `connected` event handler only logged but didn't call `setConnected()`.

### Fix
```typescript
// Before
pusher.connection.bind('connected', () => {
  console.log('[ReverbClient] Pusher connected');
});

// After
pusher.connection.bind('connected', () => {
  console.log('[ReverbClient] Pusher connected');
  this.connectionState.setConnected();
  this.notifyListeners();
});
```

### Simulation
1. Start with Reverb stopped → SERVER shows OFFLINE
2. Start Reverb (`php artisan reverb:start`)
3. Expected: SERVER changes to ONLINE within reconnect interval
4. Result: ✓ PASS

---

## Bug #3: Error Events Not Updating State

### Problem
WebSocket errors weren't updating the connection state.

### Fix
```typescript
// Before
pusher.connection.bind('error', (error: Error) => {
  console.error('[ReverbClient] Pusher error:', error);
  logActivity({...});
});

// After
pusher.connection.bind('error', (error: Error) => {
  console.error('[ReverbClient] Pusher error:', error);
  this.connectionState.handleError(
    ErrorCodes.WEBSOCKET_ERROR,
    error.message || 'WebSocket error'
  );
  this.notifyListeners();
  logActivity({...});
});
```

---

## Tests Added

File: `tests/unit/background/reverb-client.test.ts`

```typescript
describe('connection state events', () => {
  it('updates state to CONNECTED on pusher connected event', async () => {
    // Verifies setConnected() is called when Pusher connects
  });

  it('updates state on pusher disconnected event', async () => {
    // Verifies handleError() is called when Pusher disconnects
  });

  it('updates state on pusher error event', async () => {
    // Verifies handleError() is called on Pusher errors
  });
});
```

### Test Results
```
✓ updates state to CONNECTED on pusher connected event
✓ updates state on pusher disconnected event
✓ updates state on pusher error event
```

---

## Full Simulation Checklist

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 1 | Start Laravel, Reverb, browser-mcp | All servers running | ✓ |
| 2 | Load extension, sign in | User card shows | ✓ |
| 3 | Check SERVER indicator | Shows ONLINE | ✓ |
| 4 | Stop Reverb server | SERVER → RETRY/OFFLINE | ✓ |
| 5 | Start Reverb server | SERVER → ONLINE | ✓ |
| 6 | Stop Laravel server | SERVER → OFFLINE (auth fails) | ✓ |
| 7 | Start Laravel server | SERVER → ONLINE after reauth | ✓ |

---

## Files Modified

| File | Changes |
|------|---------|
| `src/background/reverb-client.ts` | Added state updates in connected/disconnected/error handlers |
| `tests/unit/background/reverb-client.test.ts` | Added 3 tests for connection state events |

---

## Notes

### Two Connection Systems
The extension manages two independent connections:

1. **Reverb (port 8085)** - Controls SERVER indicator
   - Used for receiving commands from Laravel
   - Requires authentication

2. **browser-mcp (port 8765)** - Shown in activity log
   - Used for local MCP tool commands
   - Does NOT affect SERVER indicator

Activity log message "Connected to browser-mcp on port 8765" is from the MCP connection, not Reverb.
